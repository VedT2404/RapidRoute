<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RapidRoute Control Panel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f4f7f6; color: #333; }
        .container { max-width: 900px; margin: 20px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1, h2 { color: #2c3e50; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; }
        .main-layout { display: flex; flex-wrap: wrap; gap: 20px; }
        .left-panel { flex: 1; min-width: 400px; }
        .right-panel { flex: 0 0 300px; }
        .route-planner { display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 20px; }
        .planner-group { display: flex; flex-direction: column; }
        label { font-weight: bold; margin-bottom: 8px; font-size: 0.9em; color: #555; }
        select { padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 1em; background-color: #fff; }
        button { padding: 12px 20px; font-size: 1em; font-weight: bold; color: #fff; background-color: #3498db; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; }
        button:hover { background-color: #2980b9; }
        #mqtt-log { height: 400px; background-color: #2c3e50; color: #ecf0f1; font-family: 'Courier New', Courier, monospace; overflow-y: scroll; padding: 15px; border-radius: 5px; font-size: 0.85em; white-space: pre-wrap; word-wrap: break-word; }
        #status { font-style: italic; color: #7f8c8d; text-align: center; margin-top: 15px; }
        .log-entry { padding: 2px 0; border-bottom: 1px solid #34495e; }
        .log-alert { color: #f1c40f; font-weight: bold; }
        .log-arrival { color: #2ecc71; font-weight: bold; }

        /* --- Traffic Light Styles --- */
        .traffic-light-container { padding: 20px; background-color: #ecf0f1; border-radius: 8px; text-align: center; }
        .light-grid { display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); gap: 15px; max-width: 250px; margin: 20px auto; }
        .light-pair { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .light { width: 30px; height: 30px; border-radius: 50%; margin: 5px; background-color: #7f8c8d; opacity: 0.3; transition: opacity 0.3s, background-color 0.3s; }
        .light.red { background-color: #c0392b; }
        .light.green { background-color: #27ae60; }
        .light.active { opacity: 1; box-shadow: 0 0 15px 3px currentColor; }
        .direction-label { font-weight: bold; font-size: 0.8em; }
        [data-direction="North"] { grid-column: 2; grid-row: 1; }
        [data-direction="North-East"] { grid-column: 3; grid-row: 1; }
        [data-direction="East"] { grid-column: 3; grid-row: 2; }
        [data-direction="South-East"] { grid-column: 3; grid-row: 3; }
        [data-direction="South"] { grid-column: 2; grid-row: 3; }
        [data-direction="South-West"] { grid-column: 1; grid-row: 3; }
        [data-direction="West"] { grid-column: 1; grid-row: 2; }
        [data-direction="North-West"] { grid-column: 1; grid-row: 1; }
    </style>
</head>
<body>
    <div class="container">
        <h1>RapidRoute Simulation Control Panel</h1>
        <div class="main-layout">
            <div class="left-panel">
                <div class="route-planner">
                    <div class="planner-group">
                        <label for="start-signal">Start Point</label>
                        <select id="start-signal"></select>
                    </div>
                    <div class="planner-group">
                        <label for="mid-signal">Mid Point (Waypoint)</label>
                        <select id="mid-signal"></select>
                    </div>
                    <div class="planner-group">
                        <label for="end-signal">End Point (Destination)</label>
                        <select id="end-signal"></select>
                    </div>
                </div>
                <button id="start-button">Start Manual Simulation</button>
                <p id="status">Select a route and click start.</p>
                <h2>Live Receiver Output</h2>
                <div id="mqtt-log"></div>
            </div>
            <div class="right-panel">
                <h2>Signal Status</h2>
                <div class="traffic-light-container">
                    <div class="light-grid">
                        <div class="light-pair" data-direction="North"><div class="light red active"></div><div class="light green"></div><div class="direction-label">N</div></div>
                        <div class="light-pair" data-direction="North-East"><div class="light red active"></div><div class="light green"></div><div class="direction-label">NE</div></div>
                        <div class="light-pair" data-direction="East"><div class="light red active"></div><div class="light green"></div><div class="direction-label">E</div></div>
                        <div class="light-pair" data-direction="South-East"><div class="light red active"></div><div class="light green"></div><div class="direction-label">SE</div></div>
                        <div class="light-pair" data-direction="South"><div class="light red active"></div><div class="light green"></div><div class="direction-label">S</div></div>
                        <div class="light-pair" data-direction="South-West"><div class="light red active"></div><div class="light green"></div><div class="direction-label">SW</div></div>
                        <div class="light-pair" data-direction="West"><div class="light red active"></div><div class="light green"></div><div class="direction-label">W</div></div>
                        <div class="light-pair" data-direction="North-West"><div class="light red active"></div><div class="light green"></div><div class="direction-label">NW</div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==============================================================================
        // --- CONFIGURATION & STATE ---
        // ==============================================================================
        const mqtt_broker = "broker.hivemq.com";
        const mqtt_port = 8884;
        const location_topic = "rapidroute/location/data";
        const clientId = "ControlPanel-" + parseInt(Math.random() * 1000);

        const ALERT_DISTANCE_METERS = 800.0;
        const ARRIVAL_DISTANCE_METERS = 50.0;

        // --- UPDATED: Synchronized On-board Signal Database ---
        const signals = [
            {id: 1, name: "Chakli Circle", lat: 22.308333, lon: 73.165278},
            {id: 2, name: "Diwalipura Circle", lat: 22.301806, lon: 73.165500},
            {id: 3, name: "Elora T-Junction", lat: 22.315333, lon: 73.161444},
            {id: 4, name: "Genda Circle (Natubhai Circle)", lat: 22.309944, lon: 73.158667},
            {id: 5, name: "Gotri Circle", lat: 22.315556, lon: 73.138000},
            {id: 6, name: "Hari Nagar Char Rasta", lat: 22.311278, lon: 73.153167},
            {id: 7, name: "ISKCON Circle", lat: 22.303361, lon: 73.151833},
            {id: 8, name: "Manisha Circle", lat: 22.296306, lon: 73.164583},
            {id: 9, name: "Nilamber Circle", lat: 22.302000, lon: 73.138944},
            {id: 10, name: "Tandalja SP T-Junction (Natubhai Circle)", lat: 22.280444, lon: 73.153194}
        ];
        
        let signalIdToName = {};
        let lastApproachingSignal = "";
        let lastDistanceToSignal = 99999.0;
        let alertSentForCurrentSignal = false;

        // ==============================================================================
        // --- HELPER FUNCTIONS ---
        // ==============================================================================
        
        function haversine(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const toRad = (deg) => deg * Math.PI / 180;
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat / 2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2)**2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function calculateBearing(lat1, lon1, lat2, lon2) {
            const toRad = (deg) => deg * Math.PI / 180;
            const toDeg = (rad) => rad * 180 / Math.PI;
            const dLon = toRad(lon2 - lon1);
            const y = Math.sin(dLon) * Math.cos(toRad(lat2));
            const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) - Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(dLon);
            let bearing = toDeg(Math.atan2(y, x));
            return (bearing + 360) % 360;
        }

        function bearingToDirection(bearing) {
            if (bearing >= 337.5 || bearing < 22.5) return "North";
            if (bearing >= 22.5 && bearing < 67.5) return "North-East";
            if (bearing >= 67.5 && bearing < 112.5) return "East";
            if (bearing >= 112.5 && bearing < 157.5) return "South-East";
            if (bearing >= 157.5 && bearing < 202.5) return "South";
            if (bearing >= 202.5 && bearing < 247.5) return "South-West";
            if (bearing >= 247.5 && bearing < 292.5) return "West";
            if (bearing >= 292.5 && bearing < 337.5) return "North-West";
            return "Unknown";
        }
        
        function findSignalById(id) {
            return signals.find(signal => signal.id === id);
        }
        
        function resetTrafficLights() {
            document.querySelectorAll('.light.green').forEach(light => light.classList.remove('active'));
            document.querySelectorAll('.light.red').forEach(light => light.classList.add('active'));
        }

        function updateTrafficLights(approachDirection) {
            resetTrafficLights();
            const targetPair = document.querySelector(`.light-pair[data-direction="${approachDirection}"]`);
            if (targetPair) {
                targetPair.querySelector('.green').classList.add('active');
                targetPair.querySelector('.red').classList.remove('active');
            }
        }

        // --- MQTT & SIMULATION LOGIC ---

        function appendToLog(text, type = 'info') {
            const logContainer = document.getElementById('mqtt-log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            if (type === 'alert') entry.classList.add('log-alert');
            if (type === 'arrival') entry.classList.add('log-arrival');
            entry.textContent = text;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        function populateSignalDropdowns() {
            signals.forEach(signal => {
                signalIdToName[signal.id] = signal.name;
            });
            const selects = [
                document.getElementById('start-signal'),
                document.getElementById('mid-signal'),
                document.getElementById('end-signal')
            ];
            selects.forEach(sel => sel.innerHTML = '');
            signals.forEach(signal => {
                const option = new Option(`${signal.id}: ${signal.name}`, signal.id);
                selects.forEach(sel => sel.add(option.cloneNode(true)));
            });
        }

        async function startSimulation() {
            const startId = document.getElementById('start-signal').value;
            const midId = document.getElementById('mid-signal').value;
            const endId = document.getElementById('end-signal').value;
            const statusElement = document.getElementById('status');
            
            if (!startId || !midId || !endId) {
                statusElement.textContent = "Please select all three points.";
                return;
            }
            statusElement.textContent = "Calculating route...";
            try {
                const response = await fetch('/start-manual-route', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ start: startId, mid: midId, end: endId })
                });
                const result = await response.json();
                if (response.ok) {
                    statusElement.textContent = `Simulation Started! Route: ${result.route.join(' -> ')}`;
                } else { throw new Error(result.message); }
            } catch (error) {
                console.error("Failed to start simulation:", error);
                statusElement.textContent = `Error: ${error.message}`;
            }
        }

        function connectMqtt() {
            const client = new Paho.MQTT.Client(mqtt_broker, mqtt_port, clientId);
            client.onConnectionLost = responseObject => {
                if (responseObject.errorCode !== 0) console.error("Connection lost:", responseObject.errorMessage);
            };
            
            client.onMessageArrived = message => {
                const payload = message.payloadString;
                const parts = payload.split(',');
                if (parts.length < 7) return;

                const vehicleLat = parseFloat(parts[0]);
                const vehicleLon = parseFloat(parts[1]);
                const startId = parseInt(parts[4], 10);
                const destId = parseInt(parts[5], 10);
                const nextSignalId = parseInt(parts[6], 10);

                const startSignal = findSignalById(startId);
                const destSignal = findSignalById(destId);
                const nextSignal = findSignalById(nextSignalId);

                if (!startSignal || !destSignal || !nextSignal) {
                    console.error("Could not find signal for received ID. Data might be out of sync.");
                    return;
                }
                
                const distanceToNextSignal = haversine(vehicleLat, vehicleLon, nextSignal.lat, nextSignal.lon);

                if (lastApproachingSignal !== nextSignal.name) {
                    lastApproachingSignal = nextSignal.name;
                    lastDistanceToSignal = 99999.0;
                    alertSentForCurrentSignal = false;
                }

                const statusText = `Start: ${startSignal.name} | Dest: ${destSignal.name} | Next: ${nextSignal.name} | Dist: ${distanceToNextSignal.toFixed(0)}m`;
                appendToLog(statusText, 'info');

                if (distanceToNextSignal <= ARRIVAL_DISTANCE_METERS && !alertSentForCurrentSignal) {
                    const arrivalText = `>>> YOU HAVE ARRIVED AT: ${nextSignal.name}`;
                    appendToLog(arrivalText, 'arrival');
                    alertSentForCurrentSignal = true;
                    resetTrafficLights();
                } else if (distanceToNextSignal <= ALERT_DISTANCE_METERS && distanceToNextSignal < lastDistanceToSignal && !alertSentForCurrentSignal) {
                    const bearing = calculateBearing(vehicleLat, vehicleLon, nextSignal.lat, nextSignal.lon);
                    const reciprocalBearing = (bearing + 180) % 360;
                    const approachDirection = bearingToDirection(reciprocalBearing);
                    const alertText = `  ==> !!! ALERT: Approaching '${nextSignal.name}' from the ${approachDirection} !!!`;
                    appendToLog(alertText, 'alert');
                    updateTrafficLights(approachDirection);
                } else {
                    if (!alertSentForCurrentSignal) {
                       resetTrafficLights();
                    }
                }
                
                lastDistanceToSignal = distanceToNextSignal;
            };

            client.connect({
                onSuccess: () => {
                    console.log("Connected to MQTT broker!");
                    client.subscribe(location_topic);
                },
                useSSL: true,
                onFailure: () => console.error("MQTT connection failed.")
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            populateSignalDropdowns();
            connectMqtt();
            document.getElementById('start-button').addEventListener('click', startSimulation);
        });
    </script>
</body>
</html>

