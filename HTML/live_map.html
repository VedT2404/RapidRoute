<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Vehicle Tracker</title>
    <!-- Leaflet.js CSS and JS (for the map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Paho MQTT Client (for receiving data) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        body, html { height: 100%; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; flex-direction: column; }
        #map { flex-grow: 1; }
        #header { background-color: #2c3e50; color: white; padding: 10px 20px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 1000; }
        #header h1 { margin: 0; font-size: 1.5em; }
        #header p { margin: 5px 0 0; font-size: 0.9em; opacity: 0.8; }
        #centerButton { position: absolute; top: 80px; right: 10px; z-index: 1000; background-color: white; border: 2px solid #ccc; border-radius: 5px; padding: 10px; cursor: pointer; font-size: 1.2em; box-shadow: 0 1px 4px rgba(0,0,0,0.3); }
        .vehicle-icon { font-size: 24px; text-align: center; line-height: 32px; }
    </style>
</head>
<body>
    <div id="header">
        <h1>Live Vehicle Simulation</h1>
        <p id="status">Connecting...</p>
    </div>
    <div id="map"></div>
    <button id="centerButton" title="Center on Vehicle">ðŸŽ¯</button>

    <script>
        // --- Configuration ---
        const mqtt_broker = "broker.hivemq.com";
        const mqtt_port = 8884; // Using Secure WebSocket
        const mqtt_topic = "rapidroute/location/data";
        const clientId = "WebApp-Map-" + parseInt(Math.random() * 1000);
        // This must be the IP of the computer running the Python server
        const serverIp = "192.168.137.1"; 

        // --- Map and State Variables ---
        let map;
        let vehicleMarker;
        let currentRoutePolyline = null;
        let currentDestinationId = null; 

        // --- Initialize the Map ---
        function initMap() {
            map = L.map('map').setView([22.3072, 73.1812], 13); // Centered on Vadodara
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: 'Â© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);
        }

        // --- MQTT Connection ---
        function connectMqtt() {
            const statusElement = document.getElementById('status');
            const client = new Paho.MQTT.Client(mqtt_broker, mqtt_port, clientId);

            client.onConnectionLost = onConnectionLost;
            client.onMessageArrived = onMessageArrived;

            client.connect({
                onSuccess: onConnect,
                onFailure: onFailure,
                useSSL: true
            });

            function onConnect() {
                console.log("Connected to MQTT broker!");
                statusElement.textContent = "Live";
                statusElement.style.color = "#27ae60";
                client.subscribe(mqtt_topic);
            }

            function onFailure(response) {
                console.error("Connection failed:", response.errorMessage);
                statusElement.textContent = "Connection Failed. Retrying...";
                setTimeout(connectMqtt, 5000);
            }

            function onConnectionLost(responseObject) {
                if (responseObject.errorCode !== 0) {
                    console.error("Connection lost:", responseObject.errorMessage);
                    statusElement.textContent = "Reconnecting...";
                    connectMqtt();
                }
            }

            function onMessageArrived(message) {
                try {
                    const payload = message.payloadString;
                    // Format: lat,lon,prev_lat,prev_lon,start_id,dest_id,next_id
                    const parts = payload.split(',');
                    if (parts.length < 7) return;

                    const lat = parseFloat(parts[0]);
                    const lon = parseFloat(parts[1]);
                    const destId = parseInt(parts[5], 10);
                    
                    if (isNaN(lat) || isNaN(lon)) return;

                    // Update marker position
                    if (!vehicleMarker) {
                        const vehicleIcon = L.divIcon({ html: 'ðŸš—', className: 'vehicle-icon', iconSize: [32, 32] });
                        vehicleMarker = L.marker([lat, lon], { icon: vehicleIcon }).addTo(map);
                        map.setView([lat, lon], 16);
                    } else {
                        vehicleMarker.setLatLng([lat, lon]);
                    }

                    // --- NEW: Route Drawing Logic ---
                    if (destId !== currentDestinationId) {
                        console.log("New destination detected. Fetching new route...");
                        currentDestinationId = destId;
                        fetchAndDrawRoute();
                    }

                } catch (e) {
                    console.error("Error processing message:", e);
                }
            }
        }
        
        // --- Function to fetch the route from the server and draw it on the map ---
        async function fetchAndDrawRoute() {
            try {
                // This is the new endpoint we added to the Python server
                const routeUrl = `http://${serverIp}:5000/route`;
                const response = await fetch(routeUrl); 
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const routePoints = await response.json();

                // Remove the old route line if it exists
                if (currentRoutePolyline) {
                    map.removeLayer(currentRoutePolyline);
                }

                // Draw the new route as a blue line
                currentRoutePolyline = L.polyline(routePoints, { color: '#0055ff', weight: 5, opacity: 0.7 }).addTo(map);

                // Zoom and pan the map to fit the entire route
                if (routePoints.length > 0) {
                    map.fitBounds(currentRoutePolyline.getBounds().pad(0.1)); // pad adds some margin
                }

            } catch (error) {
                console.error("Could not fetch or draw route:", error);
            }
        }

        // --- Event Listeners and Initial Calls ---
        document.getElementById('centerButton').addEventListener('click', () => {
            if (vehicleMarker) {
                map.setView(vehicleMarker.getLatLng(), 16);
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            connectMqtt();
        });
    </script>
</body>
</html>

